<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - BPS Kota Palu</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bps-blue: #005baa;
      --bps-dark: #003f7f;
      --bps-light: #e8f1fb;
      --bps-accent: #f4a700;
    }

    * { box-sizing: border-box; }
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f4f6f9; margin: 0; }

    /* ===== LOGIN PAGE ===== */
    #login-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--bps-dark) 0%, var(--bps-blue) 60%, #1a7fd4 100%);
      position: relative;
      overflow: hidden;
    }

    #login-page::before {
      content: '';
      position: absolute;
      top: -100px; right: -100px;
      width: 400px; height: 400px;
      border-radius: 50%;
      background: rgba(255,255,255,0.05);
    }

    #login-page::after {
      content: '';
      position: absolute;
      bottom: -120px; left: -80px;
      width: 350px; height: 350px;
      border-radius: 50%;
      background: rgba(255,255,255,0.04);
    }

    .login-card {
      background: white;
      border-radius: 20px;
      padding: 48px 40px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 24px 64px rgba(0,0,0,0.2);
      position: relative;
      z-index: 1;
    }

    .login-logo {
      width: 56px; height: 56px;
      background: var(--bps-light);
      border-radius: 16px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.6rem; color: var(--bps-blue);
      margin: 0 auto 20px;
    }

    .login-card h4 {
      font-weight: 800;
      color: var(--bps-dark);
      text-align: center;
      margin-bottom: 4px;
    }

    .login-card p {
      text-align: center;
      color: #888;
      font-size: 0.88rem;
      margin-bottom: 32px;
    }

    .login-label {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--bps-dark);
      margin-bottom: 6px;
      display: block;
    }

    .login-input {
      width: 100%;
      border: 1.5px solid #e0eaf5;
      border-radius: 10px;
      padding: 11px 14px;
      font-size: 0.9rem;
      font-family: inherit;
      transition: border-color 0.2s;
      outline: none;
      margin-bottom: 16px;
    }

    .login-input:focus { border-color: var(--bps-blue); box-shadow: 0 0 0 3px rgba(0,91,170,0.1); }

    .btn-login {
      width: 100%;
      background: linear-gradient(135deg, var(--bps-blue), var(--bps-dark));
      color: white;
      border: none;
      border-radius: 10px;
      padding: 13px;
      font-weight: 700;
      font-size: 0.95rem;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.25s;
      margin-top: 8px;
    }

    .btn-login:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,91,170,0.3);
    }

    .btn-login:disabled { opacity: 0.7; cursor: not-allowed; }

    .login-error {
      background: #fde8e8;
      color: #c0392b;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 0.85rem;
      margin-bottom: 16px;
      display: none;
    }

    /* ===== DASHBOARD ===== */
    #dashboard-page { display: none; min-height: 100vh; }

    .admin-navbar {
      background: linear-gradient(135deg, var(--bps-dark), var(--bps-blue));
      padding: 0 24px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 12px rgba(0,91,170,0.3);
    }

    .admin-brand {
      font-weight: 800;
      color: white;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .admin-brand span { color: var(--bps-accent); }

    .btn-logout {
      background: rgba(255,255,255,0.15);
      border: 1.5px solid rgba(255,255,255,0.3);
      color: white;
      border-radius: 8px;
      padding: 6px 16px;
      font-size: 0.82rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-logout:hover { background: rgba(255,255,255,0.25); }

    .dashboard-body { padding: 28px 24px; max-width: 1200px; margin: 0 auto; }

    /* STATS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 28px;
    }

    @media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 480px) { .stats-grid { grid-template-columns: 1fr; } }

    .stat-card {
      background: white;
      border-radius: 14px;
      padding: 22px 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(0,91,170,0.07);
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .stat-icon {
      width: 48px; height: 48px;
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.3rem;
      flex-shrink: 0;
    }

    .stat-icon.blue { background: var(--bps-light); color: var(--bps-blue); }
    .stat-icon.yellow { background: #fff8e1; color: #f4a700; }
    .stat-icon.cyan { background: #e0f7fa; color: #0097a7; }
    .stat-icon.green { background: #e8f5e9; color: #388e3c; }

    .stat-num { font-size: 1.8rem; font-weight: 800; color: var(--bps-dark); line-height: 1; }
    .stat-lbl { font-size: 0.78rem; color: #888; margin-top: 3px; }

    /* TABLE SECTION */
    .table-section {
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(0,91,170,0.07);
      overflow: hidden;
    }

    .table-header {
      padding: 20px 24px;
      border-bottom: 1px solid #f0f4f8;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .table-header h5 {
      font-weight: 800;
      color: var(--bps-dark);
      margin: 0;
      font-size: 1rem;
    }

    .filter-group { display: flex; gap: 8px; flex-wrap: wrap; }

    .filter-select {
      border: 1.5px solid #e0eaf5;
      border-radius: 8px;
      padding: 7px 12px;
      font-size: 0.82rem;
      font-family: inherit;
      color: #555;
      outline: none;
      cursor: pointer;
    }

    .filter-select:focus { border-color: var(--bps-blue); }

    .btn-refresh {
      background: var(--bps-light);
      border: none;
      border-radius: 8px;
      padding: 7px 14px;
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--bps-blue);
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-refresh:hover { background: var(--bps-blue); color: white; }

    /* TABLE */
    .table-wrap { overflow-x: auto; }

    table { width: 100%; border-collapse: collapse; }
    thead th {
      background: #f8fafd;
      padding: 12px 16px;
      font-size: 0.75rem;
      font-weight: 700;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #f0f4f8;
      white-space: nowrap;
    }

    tbody td {
      padding: 14px 16px;
      font-size: 0.86rem;
      color: #444;
      border-bottom: 1px solid #f8fafd;
      vertical-align: middle;
    }

    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover td { background: #fafcff; }

    .tiket-cell {
      font-weight: 700;
      color: var(--bps-blue);
      font-size: 0.82rem;
    }

    /* STATUS BADGES */
    .badge-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      white-space: nowrap;
    }

    .badge-menunggu { background: #fff3cd; color: #856404; }
    .badge-diproses  { background: #cff4fc; color: #055160; }
    .badge-selesai   { background: #d1e7dd; color: #0a3622; }
    .badge-ditolak   { background: #f8d7da; color: #842029; }

    /* STATUS SELECT */
    .status-select {
      border: 1.5px solid #e0eaf5;
      border-radius: 8px;
      padding: 5px 10px;
      font-size: 0.8rem;
      font-family: inherit;
      cursor: pointer;
      outline: none;
      background: white;
      min-width: 160px;
    }

    .status-select:focus { border-color: var(--bps-blue); }

    .btn-save-status {
      background: var(--bps-blue);
      color: white;
      border: none;
      border-radius: 7px;
      padding: 5px 12px;
      font-size: 0.78rem;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-save-status:hover { background: var(--bps-dark); }
    .btn-save-status:disabled { opacity: 0.6; cursor: not-allowed; }

    .btn-doc {
      color: var(--bps-blue);
      font-size: 0.8rem;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border: 1.5px solid var(--bps-light);
      border-radius: 7px;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-doc:hover { background: var(--bps-blue); color: white; border-color: var(--bps-blue); }

    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #aaa;
    }

    .empty-state i { font-size: 3rem; margin-bottom: 12px; display: block; }
    .empty-state p { font-size: 0.9rem; }

    /* LOADING */
    .loading-row td {
      text-align: center;
      padding: 40px;
      color: #aaa;
    }

    /* TOAST */
    .toast-msg {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #2e7d32;
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 0.88rem;
      font-weight: 600;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      z-index: 9999;
      display: none;
      align-items: center;
      gap: 8px;
    }

    .toast-msg.show { display: flex; }
    .toast-msg.error { background: #c62828; }

    @media (max-width: 768px) {
      .dashboard-body { padding: 16px; }
      .admin-navbar { padding: 0 16px; }
    }
  </style>
</head>
<body>

<!-- ===== LOGIN PAGE ===== -->
<div id="login-page">
  <div class="login-card">
    <div class="login-logo"><i class="bi bi-shield-lock-fill"></i></div>
    <h4>Admin Panel</h4>
    <p>BPS Kota Palu — Sistem Pengajuan Layanan</p>

    <div class="login-error" id="login-error"></div>

    <label class="login-label">Email</label>
    <input type="email" class="login-input" id="login-email" placeholder="admin@bpspalu.go.id">

    <label class="login-label">Password</label>
    <input type="password" class="login-input" id="login-password" placeholder="••••••••"
      onkeypress="if(event.key==='Enter') doLogin()">

    <button class="btn-login" id="btn-login" onclick="doLogin()">
      <i class="bi bi-box-arrow-in-right me-2"></i>Masuk
    </button>
  </div>
</div>

<!-- ===== DASHBOARD PAGE ===== -->
<div id="dashboard-page">
  <!-- Navbar -->
  <div class="admin-navbar">
    <div class="admin-brand">
      <i class="bi bi-bar-chart-fill"></i>
      BPS <span>Kota Palu</span> &nbsp;·&nbsp; Admin Panel
    </div>
    <button class="btn-logout" onclick="doLogout()">
      <i class="bi bi-box-arrow-right"></i> Keluar
    </button>
  </div>

  <div class="dashboard-body">

    <!-- Stats -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="stat-icon blue"><i class="bi bi-inbox-fill"></i></div>
        <div><div class="stat-num" id="stat-total">-</div><div class="stat-lbl">Total Pengajuan</div></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon yellow"><i class="bi bi-hourglass-split"></i></div>
        <div><div class="stat-num" id="stat-menunggu">-</div><div class="stat-lbl">Menunggu Verifikasi</div></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon cyan"><i class="bi bi-arrow-repeat"></i></div>
        <div><div class="stat-num" id="stat-diproses">-</div><div class="stat-lbl">Sedang Diproses</div></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green"><i class="bi bi-check-circle-fill"></i></div>
        <div><div class="stat-num" id="stat-selesai">-</div><div class="stat-lbl">Selesai</div></div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-section">
      <div class="table-header">
        <h5><i class="bi bi-list-ul me-2" style="color:var(--bps-blue);"></i>Daftar Pengajuan</h5>
        <div class="filter-group">
          <select class="filter-select" id="filter-status" onchange="loadData()">
            <option value="">Semua Status</option>
            <option value="Menunggu Verifikasi">Menunggu Verifikasi</option>
            <option value="Sedang Diproses">Sedang Diproses</option>
            <option value="Selesai">Selesai</option>
            <option value="Ditolak">Ditolak</option>
          </select>
          <select class="filter-select" id="filter-layanan" onchange="loadData()">
            <option value="">Semua Layanan</option>
            <option value="Pelayanan Konsultasi Statistik">Konsultasi Statistik</option>
            <option value="Pelayanan Perpustakaan">Perpustakaan</option>
            <option value="Pelayanan Produk Statistik Berbayar">Produk Statistik</option>
            <option value="Pelayanan Rekomendasi Kegiatan Statistik">Rekomendasi Statistik</option>
          </select>
          <button class="btn-refresh" onclick="loadData()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>No. Tiket</th>
              <th>Nama</th>
              <th>Jenis Layanan</th>
              <th>Instansi</th>
              <th>Tanggal</th>
              <th>Dokumen</th>
              <th>Status</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <tr class="loading-row"><td colspan="8"><i class="bi bi-arrow-repeat"></i> Memuat data...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- TOAST -->
<div class="toast-msg" id="toast"><i class="bi bi-check-circle-fill"></i><span id="toast-text"></span></div>

<script>
  const SUPABASE_URL = 'https://rljhayfmfsrdtpmlqltp.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsamhheWZtZnNyZHRwbWxxbHRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIzMzc5NTcsImV4cCI6MjA4NzkxMzk1N30.1Iyu5DYkQyqnmu9eLT1Kcf7ybOI4V4-bXHr7b7NyR7c';

  let accessToken = null;

  // ===== LOGIN =====
  async function doLogin() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    const errEl = document.getElementById('login-error');
    const btn = document.getElementById('btn-login');

    errEl.style.display = 'none';
    if (!email || !password) {
      errEl.textContent = 'Email dan password wajib diisi!';
      errEl.style.display = 'block';
      return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Memproses...';

    try {
      const res = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_KEY
        },
        body: JSON.stringify({ email, password })
      });

      const data = await res.json();

      if (!res.ok || !data.access_token) {
        throw new Error('Email atau password salah');
      }

      accessToken = data.access_token;
      document.getElementById('login-page').style.display = 'none';
      document.getElementById('dashboard-page').style.display = 'block';
      loadData();

    } catch (err) {
      errEl.textContent = err.message;
      errEl.style.display = 'block';
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i>Masuk';
    }
  }

  // ===== LOGOUT =====
  function doLogout() {
    accessToken = null;
    document.getElementById('dashboard-page').style.display = 'none';
    document.getElementById('login-page').style.display = 'flex';
    document.getElementById('login-password').value = '';
  }

  // ===== LOAD DATA =====
  async function loadData() {
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '<tr class="loading-row"><td colspan="8"><i class="bi bi-arrow-repeat"></i> Memuat data...</td></tr>';

    const filterStatus = document.getElementById('filter-status').value;
    const filterLayanan = document.getElementById('filter-layanan').value;

    let url = `${SUPABASE_URL}/rest/v1/pengajuan?select=*&order=created_at.desc`;
    if (filterStatus) url += `&status=eq.${encodeURIComponent(filterStatus)}`;
    if (filterLayanan) url += `&jenis_layanan=eq.${encodeURIComponent(filterLayanan)}`;

    try {
      const res = await fetch(url, {
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${accessToken}`
        }
      });

      const data = await res.json();

      // Update stats
      updateStats(data, filterStatus, filterLayanan);

      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8">
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>Belum ada pengajuan masuk</p>
          </div>
        </td></tr>`;
        return;
      }

      tbody.innerHTML = data.map(d => {
        const tgl = new Date(d.created_at).toLocaleDateString('id-ID', {
          day: 'numeric', month: 'short', year: 'numeric'
        });
        const badgeClass = {
          'Menunggu Verifikasi': 'badge-menunggu',
          'Sedang Diproses': 'badge-diproses',
          'Selesai': 'badge-selesai',
          'Ditolak': 'badge-ditolak'
        }[d.status] || 'badge-menunggu';

        const layananShort = d.jenis_layanan.replace('Pelayanan ', '');

        return `<tr>
          <td><span class="tiket-cell">${d.nomor_tiket}</span></td>
          <td>
            <div style="font-weight:600;color:#333;">${d.nama}</div>
            <div style="font-size:0.78rem;color:#aaa;">${d.email}</div>
          </td>
          <td><span style="font-size:0.82rem;">${layananShort}</span></td>
          <td style="font-size:0.82rem;">${d.instansi || '-'}</td>
          <td style="font-size:0.82rem;white-space:nowrap;">${tgl}</td>
          <td>
            ${d.url_dokumen
              ? `<a href="${d.url_dokumen}" target="_blank" class="btn-doc"><i class="bi bi-file-earmark-arrow-down"></i> Lihat</a>`
              : '<span style="color:#ccc;font-size:0.78rem;">-</span>'
            }
          </td>
          <td><span class="badge-status ${badgeClass}">${d.status}</span></td>
          <td>
            <div style="display:flex;gap:6px;align-items:center;">
              <select class="status-select" id="sel-${d.id}">
                <option value="Menunggu Verifikasi" ${d.status==='Menunggu Verifikasi'?'selected':''}>Menunggu Verifikasi</option>
                <option value="Sedang Diproses" ${d.status==='Sedang Diproses'?'selected':''}>Sedang Diproses</option>
                <option value="Selesai" ${d.status==='Selesai'?'selected':''}>Selesai</option>
                <option value="Ditolak" ${d.status==='Ditolak'?'selected':''}>Ditolak</option>
              </select>
              <button class="btn-save-status" id="btn-${d.id}" onclick="updateStatus(${d.id})">
                Simpan
              </button>
            </div>
          </td>
        </tr>`;
      }).join('');

    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#e74c3c;padding:32px;">
        Gagal memuat data: ${err.message}
      </td></tr>`;
    }
  }

  // ===== UPDATE STATS =====
  async function updateStats(filteredData, filterStatus, filterLayanan) {
    // Always fetch all for stats if no filter
    let allData = filteredData;
    if (filterStatus || filterLayanan) {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/pengajuan?select=status`, {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${accessToken}` }
      });
      allData = await res.json();
    }

    document.getElementById('stat-total').textContent = allData.length;
    document.getElementById('stat-menunggu').textContent = allData.filter(d => d.status === 'Menunggu Verifikasi').length;
    document.getElementById('stat-diproses').textContent = allData.filter(d => d.status === 'Sedang Diproses').length;
    document.getElementById('stat-selesai').textContent = allData.filter(d => d.status === 'Selesai').length;
  }

  // ===== UPDATE STATUS =====
  async function updateStatus(id) {
    const newStatus = document.getElementById(`sel-${id}`).value;
    const btn = document.getElementById(`btn-${id}`);

    btn.disabled = true;
    btn.textContent = '...';

    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/pengajuan?id=eq.${id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${accessToken}`,
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({ status: newStatus })
      });

      if (!res.ok) throw new Error('Gagal update');

      showToast('Status berhasil diperbarui!', false);
      loadData();

    } catch (err) {
      showToast('Gagal memperbarui status', true);
      btn.disabled = false;
      btn.textContent = 'Simpan';
    }
  }

  // ===== TOAST =====
  function showToast(msg, isError = false) {
    const toast = document.getElementById('toast');
    document.getElementById('toast-text').textContent = msg;
    toast.className = 'toast-msg show' + (isError ? ' error' : '');
    setTimeout(() => toast.classList.remove('show'), 3000);
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
